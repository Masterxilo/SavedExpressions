System`Cell[System`BoxData[System`RowBox[System`List["Persist", "[", System`RowBox[System`List["DefinePublicFunction", ",", "\[IndentingNewLine]", "\[IndentingNewLine]", System`RowBox[System`List[System`RowBox[System`List["UnprotectClearAll", "@", "DefinePublicFunction"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List[System`RowBox[System`List["UnprotectClearAll", "@", "DownValueUsage"]], ";"]], "*)"]], "\n", "\n", System`RowBox[System`List[System`RowBox[System`List["DefinePublicFunction", "::", "usage"]], " ", "=", " ", "\"DeclarePublicFunction[f[args] /; cond, \\\"usage\\\", body]\n\nUse like := to declare public functions.\nAll Messages and Exceptions that are generated are caught and translated to a\npackage specific message and error value, by default $Failed.\n\nAlso defines a 'wrong argument specification' handler that catches all calls with unknown arguments.\n\nTODO this could also set the usage message and documentation\nTODO this could also handle syntax hints for 'too many argument' type situations.\""]], ";", "\n", "\n", System`RowBox[System`List["DefinePublicFunction", "~", "SetAttributes", "~", "HoldAll"]], ";", "\n", System`RowBox[System`List["Unprotect", "@", "DownValueUsage"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["Quiet", "@", System`RowBox[System`List["RemoveUndefinedFunction", "@", "DownValueUsage"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["Protect", "@", "DownValueUsage"]], ";", "\n", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["--", " ", System`RowBox[System`List["Core", " ", "--"]]]], "-"]], " ", "*)"]], "\n", System`RowBox[System`List["(*", "\n", System`RowBox[System`List[System`RowBox[System`List["Makes", " ", "a", " ", "definition"]], ",", " ", System`RowBox[System`List["wrapping", " ", "it", " ", "in", " ", "all", " ", "handlers", " ", "so", " ", "as", " ", "to", " ", "catch", " ", "uncaught", " ", "things", "\n", System`RowBox[System`List["(", System`RowBox[System`List["TODO", " ", "consider", " ", "aborting", " ", "early", " ", System`RowBox[System`List["instead", " ", "--"]], " ", "or", " ", "have", " ", "the", " ", "function", " ", "declare", " ", "what", " ", "it", " ", "can", " ", "normally", " ", "throw"]], ")"]], "\n", "check", " ", "return", " ", "types"]], ",", " ", System`RowBox[System`List["fail", " ", "on", " ", "messages", " ", "generated", " ", "on", " ", "the", " ", "inside", " ", System`RowBox[System`List["etc", ".", "\n", "\n", "TODO"]], " ", "use", " ", "runtime", " ", "changeable", " ", "functions", " ", "for", " ", "callbacks"]], ",", " ", System`RowBox[System`List["instead", " ", "of", " ", "hardcoding", " ", "the", " ", "wrappers"]]]], "\n", "*)"]], "\n", System`RowBox[System`List[System`RowBox[System`List["DefinePublicFunction", "[", "\[IndentingNewLine]", System`RowBox[System`List[System`RowBox[System`List["attributes", ":", System`RowBox[System`List["{", "___", "}"]]]], ",", "\n", "  ", "f_Symbol", ",", " ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["tag", " ", "with", " ", "which", " ", "the", " ", "definition", " ", "will", " ", "be", " ", "associated"]], " ", "*)"]], "\n", "  ", "def_", ",", " ", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["actual", " ", "definition"]], ",", " ", System`RowBox[System`List["not", " ", "yet", " ", "evaluated"]], ",", " ", System`RowBox[System`List["including", " ", "condition"]]]], "*)"]], "\n", "  ", "args_List", ",", " ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["arguments", " ", "inside", " ", "of", " ", "definition"]], " ", "*)"]], "\n", "  ", System`RowBox[System`List["cond", " ", ":", " ", System`RowBox[System`List["Null", " ", "|", " ", "_"]]]], ",", " ", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["extracted", " ", "condition"]], ",", " ", System`RowBox[System`List["Null", " ", "if", " ", "none"]]]], " ", "*)"]], "\n", "  ", "usage_String", ",", " ", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["::", "usage"]], " ", "message"]], " ", "*)"]], "\n", "  ", "body_", " ", System`RowBox[System`List["(*", " ", "definition", " ", "*)"]], "\[IndentingNewLine]", "\[IndentingNewLine]", ",", " ", System`RowBox[System`List["resultPattern", " ", ":", System`RowBox[System`List["Except", "[", System`RowBox[System`List["Options", "\[Rule]", "_"]], "]"]], ":", "_"]], System`RowBox[System`List["(*", " ", System`RowBox[System`List["return", " ", "type", " ", "spec"]], " ", "*)"]], "\[IndentingNewLine]", "\[IndentingNewLine]", ",", " ", System`RowBox[System`List["error", ":", System`RowBox[System`List["Except", "[", System`RowBox[System`List["Options", "\[Rule]", "_"]], "]"]], ":", " ", "\"\""]], " ", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["helpful", " ", "message", " ", "displayed", " ", "on", " ", "function", " ", "error"]], ",", " ", System`RowBox[System`List[System`RowBox[System`List["e", ".", "g", ".", " ", "telling"]], " ", "about", " ", "the", " ", "likely", " ", "cause"]], ",", " ", System`RowBox[System`List["what", " ", "to", " ", "do", " ", "next"]]]], "*)"]], "\[IndentingNewLine]", ",", System`RowBox[System`List["opts", ":", System`RowBox[System`List["OptionsPattern", "[", "]"]]]]]], "\n", "]"]], " ", ":=", " ", System`RowBox[System`List["(", "\n", System`RowBox[System`List[System`RowBox[System`List["Unprotect", "@", "f"]], ";", "\n", System`RowBox[System`List["(*", " ", System`RowBox[System`List["Error", " ", "messages"]], " ", "*)"]], "\n", System`RowBox[System`List["(*", " ", System`RowBox[System`List["We", " ", System`RowBox[System`List["use", " ", "::", "msg"]], " ", "only", " ", "the", " ", "initial", " ", "name", " ", "of", " ", "the", " ", "message", " ", "is", " ", System`RowBox[System`List["displayed", ":", " ", System`RowBox[System`List["make", " ", "that", " ", "readable"]]]]]], " ", "*)"]], "\n", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["final", " ", "``", " ", "is", " ", "for", " ", System`RowBox[System`List["user", "'"]], "s", " ", "error", " ", System`RowBox[System`List["message", "/", "hint"]], " ", System`RowBox[System`List["(", System`RowBox[System`List["if", " ", "any"]], ")"]]]], ",", " ", System`RowBox[System`List["\\n", " ", "``", " ", "is", " ", "for", " ", System`RowBox[System`List["StackTrace", "[", "]"]]]]]], " ", "*)"]], "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["IllegalContext", "::", "msg"]], " ", "=", " ", "\"Illegal context of definition symbol `` in definition ``.\""]], ";", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["AlreadyDefined", "::", "msg"]], " ", "=", " ", "\"`` already defined. Or DownValueUsage was not properly cleaned.\\nDid you mean *Re*definePublicFunction?\""]], ";", "\n", "  ", "\n", "  ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["Create", " ", "usage", " ", "message"]], " ", "*)"]], "\n", "  ", System`RowBox[System`List["MessageAssert", "[", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["Context", "@", "f"]], " ", "=!=", " ", "\"System`\""]], ",", " ", System`RowBox[System`List["IllegalContext", "::", "msg"]], ",", " ", System`RowBox[System`List["Context", "@", "f"]], ",", " ", System`RowBox[System`List["HoldForm", "@", "def"]]]], "]"]], ";", "\n", "  ", System`RowBox[System`List["MessageAssert", "[", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["Head", "@", System`RowBox[System`List["DownValueUsage", "@", System`RowBox[System`List["HoldPattern", "@", "def"]]]]]], " ", "===", " ", "DownValueUsage"]], ",", " ", System`RowBox[System`List["AlreadyDefined", "::", "msg"]], ",", " ", System`RowBox[System`List["HoldForm", "@", "def"]]]], "]"]], ";", "\n", "\n", "  ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["usage", " ", "message", " ", "as", " ", "expected", " ", "by", " ", "Mathematica", " ", "front", " ", "end", " ", "for", " ", "proper", " ", "output", " ", "formatting", " ", "and", " ", "recognition", " ", "of", " ", "variants", "\n", "  ", System`RowBox[System`List["(", System`RowBox[System`List["on", " ", "the", " ", "blue", " ", "dropdown", " ", "menu"]], ")"]], "\n", "  ", "TODO", " ", "extract", " ", "short", " ", "parameter", " ", "names"]], " ", "*)"]], "\[IndentingNewLine]", System`RowBox[System`List["Unprotect", "@", "DownValueUsage"]], ";", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["DownValueUsage", "[", System`RowBox[System`List["Verbatim", "[", System`RowBox[System`List["HoldPattern", "@", "def"]], "]"]], "]"]], " ", "=", " ", System`RowBox[System`List[System`RowBox[System`List["StringTemplate", "[", "\"\\!\\(\\*RowBox[{\\\"``\\\", \\\"[\\\", ``, \\\"]\\\"}]\\)`` ``\"", "]"]], "[", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["ToString", "@", "f"]], "\n", "    ", ",", " ", System`RowBox[System`List["StringRiffle", "[", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["StringTemplate", "[", "\"StyleBox[\\\"``\\\", \\\"TI\\\"]\"", "]"]], " ", "/@", " ", System`RowBox[System`List["ToString", " ", "/@", " ", "args"]]]], ",", " ", "\",\\\",\\\",\""]], "]"]], "\n", "    ", ",", " ", System`RowBox[System`List["If", "[", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["Hold", "@", "cond"]], " ", "===", " ", System`RowBox[System`List["Hold", "@", "Null"]]]], ",", "\"\"", ",", " ", System`RowBox[System`List["\" /; \"", "<>", System`RowBox[System`List["ToString", "@", System`RowBox[System`List["Unevaluated", "@", "cond"]]]]]]]], "]"]], "\n", "    ", ",", " ", "usage"]], "\n", "  ", "]"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["Protect", "@", "DownValueUsage"]], ";", "\n", "\n", "  ", System`RowBox[System`List["MessageAssert", "[", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["Head", "@", System`RowBox[System`List["DownValueUsage", "@", System`RowBox[System`List["HoldPattern", "@", "def"]]]]]], " ", "=!=", " ", "DownValueUsage"]], ",", " ", System`RowBox[System`List["General", "::", "whatTheHeck"]]]], "]"]], ";", "\n", "  ", System`RowBox[System`List["StringJoinToOrSet", "[", System`RowBox[System`List[System`RowBox[System`List["f", "::", "usage"]], ",", " ", System`RowBox[System`List["DownValueUsage", "@", System`RowBox[System`List["HoldPattern", "@", "def"]]]], ",", " ", System`RowBox[System`List["StringRiffle", " ", "->", " ", "\"\\n\""]]]], "]"]], ";", "\n", "\n", "  ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["Extend", " ", "syntaxInformation"]], " ", "*)"]], "\n", "  ", System`RowBox[System`List["Module", "[", System`RowBox[System`List[System`RowBox[System`List["{", "\n", "    ", System`RowBox[System`List["minmaxargc", " ", "=", " ", System`RowBox[System`List["MinMax", "@", System`RowBox[System`List["DeleteMissing", "@", System`RowBox[System`List["{", System`RowBox[System`List[System`RowBox[System`List["CountArgumentsFromSyntaxInformation", "@", "f"]], ",", " ", System`RowBox[System`List["Length", "@", "args"]]]], "}"]]]]]]]], "\n", "  ", "}"]], ",", "\n", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["SyntaxInformation", "[", "f", "]"]], " ", "=", " ", System`RowBox[System`List["{", System`RowBox[System`List["\"ArgumentsPattern\"", "->", System`RowBox[System`List["SyntaxInformationArgumentPatternForFixedArgumentCountRange", "@@", "minmaxargc"]]]], "}"]]]], ";"]]]], "\n", "  ", "]"]], ";", "\n", "\n", "  ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["do", " ", "the", " ", "definition"]], " ", "*)"]], "\[IndentingNewLine]", System`RowBox[System`List["SetAttributes", "[", System`RowBox[System`List["f", ",", "attributes"]], "]"]], ";", "\[IndentingNewLine]", System`RowBox[System`List[System`RowBox[System`List["Options", "@", "f"]], "=", System`RowBox[System`List[System`RowBox[System`List["Options", "@", "f"]], "~", "Join", "~", System`RowBox[System`List["OptionValue", "@", "Options"]]]]]], ";", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["call", " ", ":", " ", "def"]], " ", ":=", " ", System`RowBox[System`List["CatchMessagesAndTypeCheck", "[", System`RowBox[System`List["body", ",", " ", "resultPattern", ",", System`RowBox[System`List["Row", "@", System`RowBox[System`List["{", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["StringTemplate", "[", "\"In `` when called as ``. \"", "]"]], "[", System`RowBox[System`List[System`RowBox[System`List["ToString", "@", System`RowBox[System`List["HoldForm", "@", "f"]]]], ",", System`RowBox[System`List["ToString", "@", System`RowBox[System`List["HoldForm", "@", "call"]]]]]], "]"]], ",", " ", "error"]], "}"]]]]]], "]"]]]], ";", "\n", "\n", "  ", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["Do", " ", "the", " ", "undefined", " ", "fallback", " ", "definition"]], ",", " ", System`RowBox[System`List["but", " ", "only", " ", "once", " ", "and", " ", "put", " ", "it", " ", "at", " ", "the", " ", "end", " ", "of", " ", "the", " ", "list", "\n", "  ", System`RowBox[System`List["(", System`RowBox[System`List[System`RowBox[System`List["if", " ", "mathematica", " ", "cannot", " ", "order", " ", "the", " ", "patterns"]], ",", " ", System`RowBox[System`List["this", " ", "is", " ", "the", " ", "only", " ", "way", " ", "to", " ", "ensure", " ", "it", " ", "is", " ", "there"]]]], ")"]]]]]], " ", "*)"]], "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["DownValues", "@", "f"]], " ", "=", " ", System`RowBox[System`List["DeleteCases", "[", System`RowBox[System`List[System`RowBox[System`List["DownValues", "@", "f"]], ",", " ", System`RowBox[System`List["HoldPattern", "[", System`RowBox[System`List[System`RowBox[System`List["Verbatim", "@", System`RowBox[System`List["HoldPattern", "[", System`RowBox[System`List["a", " ", ":", " ", System`RowBox[System`List["f", "[", "___", "]"]]]], "]"]]]], " ", ":>", " ", "_"]], "]"]]]], "]"]]]], ";", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["DownValues", "@", "f"]], "~", "AppendTo", "~", System`RowBox[System`List["(", System`RowBox[System`List[System`RowBox[System`List["HoldPattern", "[", System`RowBox[System`List["a", " ", ":", " ", System`RowBox[System`List["f", "[", "___", "]"]]]], "]"]], " ", "\[RuleDelayed]", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List["function", " ", "body", " ", "for", " ", "undefined", " ", "case"]], "*)"]], "\[IndentingNewLine]", " ", System`RowBox[System`List["(", System`RowBox[System`List["MessageUndefined", "[", System`RowBox[System`List["HoldForm", "@", System`RowBox[System`List["Row", "@", System`RowBox[System`List["{", System`RowBox[System`List["a", ",", "\"\\n\"", ",", "error"]], "}"]]]]]], "]"]], ")"]]]], "\[IndentingNewLine]", ")"]]]], ";", "\n", "\n", System`RowBox[System`List["Protect", "@", "f"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DisallowOwnValues", "@", "f"]], ";"]], "\n", ")"]]]], ";", "\[IndentingNewLine]", "\n", System`RowBox[System`List[System`RowBox[System`List["DefinePublicFunction", "[", System`RowBox[System`List[System`RowBox[System`List["attributes", ":", System`RowBox[System`List["{", "___", "}"]], ":", System`RowBox[System`List["{", "}"]]]], ",", System`RowBox[System`List["d", " ", ":", " ", System`RowBox[System`List["(", System`RowBox[System`List[System`RowBox[System`List["f_Symbol", "[", "args___", "]"]], "~", System`RowBox[System`List["Verbatim", "[", "Condition", "]"]], "~", "c_"]], ")"]]]], ",", " ", "usage_String", ",", " ", "body_", "\[IndentingNewLine]", "\[IndentingNewLine]", ",", " ", System`RowBox[System`List["resultPattern", " ", ":", System`RowBox[System`List["Except", "[", System`RowBox[System`List["Options", "\[Rule]", "_"]], "]"]], ":", "_"]], "\[IndentingNewLine]", ",", " ", System`RowBox[System`List["error", ":", System`RowBox[System`List["Except", "[", System`RowBox[System`List["Options", "\[Rule]", "_"]], "]"]], ":", " ", "\"\""]], "\[IndentingNewLine]", ",", System`RowBox[System`List["opts", ":", System`RowBox[System`List["OptionsPattern", "[", "]"]]]]]], "\[IndentingNewLine]", "]"]], " ", ":=", "\n", "    ", System`RowBox[System`List["DefinePublicFunction", "[", System`RowBox[System`List["attributes", ",", "f", ",", " ", "d", ",", " ", System`RowBox[System`List["{", "args", "}"]], ",", " ", "c", ",", " ", "usage", ",", " ", "body", ",", "resultPattern", ",", "error", ",", "opts"]], "]"]]]], ";", "\[IndentingNewLine]", "\n", "\n", System`RowBox[System`List[System`RowBox[System`List["DefinePublicFunction", "[", System`RowBox[System`List[System`RowBox[System`List["attributes", ":", System`RowBox[System`List["{", "___", "}"]], ":", System`RowBox[System`List["{", "}"]]]], System`RowBox[System`List["(*", System`RowBox[System`List["cannot", " ", "use", " ", System`RowBox[System`List["{", "__", "}"]], " ", System`RowBox[System`List["bug", "?"]]]], "*)"]], ",", System`RowBox[System`List["d", " ", ":", System`RowBox[System`List[System`RowBox[System`List["Except", "[", System`RowBox[System`List[System`RowBox[System`List["Condition", "|", "List"]], ",", " ", "f_Symbol"]], "]"]], "[", "args___", "]"]]]], ",", " ", "usage_String", ",", " ", "body_", "\[IndentingNewLine]", "\[IndentingNewLine]", ",", " ", System`RowBox[System`List["resultPattern", " ", ":", System`RowBox[System`List["Except", "[", System`RowBox[System`List["Options", "\[Rule]", "_"]], "]"]], ":", "_"]], "\[IndentingNewLine]", ",", " ", System`RowBox[System`List["error", ":", System`RowBox[System`List["Except", "[", System`RowBox[System`List["Options", "\[Rule]", "_"]], "]"]], ":", " ", "\"\""]], "\[IndentingNewLine]", ",", System`RowBox[System`List["opts", ":", System`RowBox[System`List["OptionsPattern", "[", "]"]]]]]], "\[IndentingNewLine]", "]"]], " ", ":=", "\n", "    ", System`RowBox[System`List["DefinePublicFunction", "[", System`RowBox[System`List["attributes", ",", "f", ",", " ", "d", ",", " ", System`RowBox[System`List["{", "args", "}"]], ",", " ", "Null", ",", " ", "usage", ",", " ", "body", ",", "resultPattern", ",", "error", ",", "opts"]], "]"]]]], ";", "\[IndentingNewLine]", "\n", System`RowBox[System`List[System`RowBox[System`List["Options", "@", "DefinePublicFunction"]], "=", System`RowBox[System`List["{", System`RowBox[System`List["Options", "\[Rule]", System`RowBox[System`List["{", "}"]]]], "}"]]]], ";", "\[IndentingNewLine]", "\n", System`RowBox[System`List["MakeUndefinedFunctionProtect", "@", "DefinePublicFunction"]], ";"]]]], "\[IndentingNewLine]", "]"]]], "Input", System`Rule[System`CellChangeTimes, System`List[System`List[3.681486894799464`*^9, 3.681486931596734`*^9], System`List[3.6814871094132504`*^9, 3.6814871367958755`*^9], System`List[3.6814873503822236`*^9, 3.6814873674869003`*^9], System`List[3.6814875034190063`*^9, 3.681487516916233`*^9], System`List[3.6814879429288254`*^9, 3.681487956397744`*^9], System`List[3.6814883415832663`*^9, 3.6814884459190392`*^9], System`List[3.6814942789422193`*^9, 3.681494299875181`*^9], System`List[3.6814948886083293`*^9, 3.681494950804872`*^9], 3.6814951285475764`*^9, System`List[3.6814951936432753`*^9, 3.681495197230499`*^9], System`List[3.681496356900399`*^9, 3.6814964781290674`*^9], 3.681499198005212`*^9, System`List[3.681499274772437`*^9, 3.681499275975629`*^9], System`List[3.681499312721405`*^9, 3.681499317819671`*^9], System`List[3.681499468443386`*^9, 3.6814994927869415`*^9], System`List[3.681501006080521`*^9, 3.6815010918239107`*^9], System`List[3.6815016373065977`*^9, 3.681501674975356`*^9], 3.681631659279024`*^9, System`List[3.6816320808467903`*^9, 3.6816320842374687`*^9], System`List[3.681632146488219`*^9, 3.6816321654103823`*^9], System`List[3.681632207676483`*^9, 3.6816322096921854`*^9], System`List[3.6816322429113507`*^9, 3.6816322552708797`*^9], System`List[3.681632321521661`*^9, 3.681632360397202`*^9], System`List[3.6816328070433645`*^9, 3.6816328340905666`*^9], 3.6816334984582367`*^9, System`List[3.681633560943448`*^9, 3.6816336020532875`*^9], System`List[3.6816337760085773`*^9, 3.681633799977681`*^9], System`List[3.681640643288972`*^9, 3.681640658688196`*^9], System`List[3.6816600536652985`*^9, 3.6816600875185757`*^9], System`List[3.681660273056199`*^9, 3.681660374230504`*^9], System`List[3.681661859727991`*^9, 3.6816619097864647`*^9], System`List[3.6857037429509974`*^9, 3.6857037767117095`*^9], System`List[3.6857038124455547`*^9, 3.6857038372097187`*^9]]], System`Rule[System`CellTags, "depersistedCell0e8e1766-0909-46c2-a347-9253f2b68d05"]]