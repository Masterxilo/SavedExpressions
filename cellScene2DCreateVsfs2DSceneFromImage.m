System`Cell[System`BoxData[System`RowBox[System`List["PRedefinePublicFunction", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", System`RowBox[System`List[System`RowBox[System`List["Scene2DCreateVsfs2DSceneFromImage", "[", System`RowBox[System`List[System`RowBox[System`List["img_Image", "?", "HasAlphaChannel"]], ",", "lightIntensityParametrized_", ",", System`RowBox[System`List["lv_", "?", "NumericVectorQ"]], System`RowBox[System`List["(*", System`RowBox[System`List["light", " ", "intensity", " ", System`RowBox[System`List["parameters", ":", System`RowBox[System`List[System`RowBox[System`List["lightIntensity", "[", System`RowBox[System`List["l", ",", "n"]], "]"]], " ", "called", " ", "for", " ", "each", " ", "normal", " ", "to", " ", "compute", " ", "c", " ", "as", " ", "image", " ", "color", "*", System`RowBox[System`List["lightIntensity", "."]]]]]]]], "*)"]], ",", System`RowBox[System`List["measurementBlur_Integer:", " ", "8"]]]], "]"]], "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", ",", "\"Creates the data for a Scene2D from an image with transparency\"", ",", "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", System`RowBox[System`List["Module", "[", System`RowBox[System`List[System`RowBox[System`List["{", System`RowBox[System`List["id", ",", "alpha", ",", "distanceField", ",", "measuredDistanceField", ",", "imgoutline", ",", "outline", ",", "xnor", ",", "ynor", ",", "normals", ",", "inormals", ",", "litImage", ",", "litOutline", ",", "litColors", ",", "diffuse", ",", System`RowBox[System`List["colorDims", "=", System`RowBox[System`List[System`RowBox[System`List["ImageChannels", "@", "img"]], "-", "1"]]]], ",", "DPrint"]], "}"]], ",", "\[IndentingNewLine]", System`RowBox[System`List[System`RowBox[System`List["DPrint", "~", "SetAttributes", "~", "HoldAll"]], ";", "\[IndentingNewLine]", System`RowBox[System`List[System`RowBox[System`List["DPrint", "[", "___", "]"]], ":=", "Null"]], ";", System`RowBox[System`List["(*", System`RowBox[System`List["TODO", " ", "allow", " ", "controlling", " ", "from", " ", System`RowBox[System`List["outside", " ", "--"]], " ", System`RowBox[System`List["use", " ", "::", "trace"]], " ", "messages"]], "*)"]], "\[IndentingNewLine]", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "colorDims"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "img"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["id", "=", System`RowBox[System`List["ImageData", "@", "img"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["alpha", "=", System`RowBox[System`List["AlphaChannel", "@", "img"]]]], System`RowBox[System`List["(*", System`RowBox[System`List["inside", " ", "is", " ", "white"]], "*)"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "alpha"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["distanceField", "=", System`RowBox[System`List["ImageData", "@", System`RowBox[System`List["DistanceTransformFull", "@", "alpha"]]]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List["distanceField", "=", System`RowBox[System`List[System`RowBox[System`List["ImageData", "@", System`RowBox[System`List["Blur", "[", System`RowBox[System`List[System`RowBox[System`List["Image", "@", "distanceField"]], ",", "1"]], "]"]]]], "blur", " ", "just", " ", "a", " ", "wee", " ", "bit", " ", "to", " ", "remove", " ", "jagged", " ", "pixel", " ", "edges"]]]], "*)"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", System`RowBox[System`List["MatrixPlot", "@", "distanceField"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["measuredDistanceField", "=", System`RowBox[System`List["ImageData", "@", System`RowBox[System`List["Blur", "[", System`RowBox[System`List[System`RowBox[System`List["Image", "@", "distanceField"]], ",", "measurementBlur"]], "]"]]]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", System`RowBox[System`List["MatrixPlot", "@", "measuredDistanceField"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", System`RowBox[System`List["Show", "[", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["ListContourPlot", "[", System`RowBox[System`List["#1", ",", System`RowBox[System`List["Contours", "\[Rule]", System`RowBox[System`List["{", "0", "}"]]]], ",", System`RowBox[System`List["ContourShading", "\[Rule]", "None"]], ",", System`RowBox[System`List["ContourStyle", "\[Rule]", "#2"]]]], "]"]], "&"]], "@@@", System`RowBox[System`List["{", System`RowBox[System`List[System`RowBox[System`List["{", System`RowBox[System`List["measuredDistanceField", ",", System`RowBox[System`List["{", System`RowBox[System`List["Thick", ",", "Red"]], "}"]]]], "}"]], ",", System`RowBox[System`List["{", System`RowBox[System`List["distanceField", ",", "Blue"]], "}"]]]], "}"]]]], "]"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["outline", "=", System`RowBox[System`List["InternalOutline", "@", "alpha"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List[System`RowBox[System`List["the", " ", "outline", " ", "is", " ", "completely", " ", "contained", " ", "in", " ", "the", " ", "shape"]], ",", System`RowBox[System`List["so", " ", "this", " ", "gives", " ", "the", " ", "same", " ", System`RowBox[System`List["image", ":"]]]]]], "*)"]], System`RowBox[System`List["DPrint", "@", System`RowBox[System`List["ImageMultiply", "[", System`RowBox[System`List["outline", ",", "alpha"]], "]"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List["edge", "-", System`RowBox[System`List["detect", " ", "creates", " ", "holes", " ", "and", " ", "thicker", " ", System`RowBox[System`List["outlines", ":"]]]]]], "*)"]], System`RowBox[System`List["DPrint", "@", System`RowBox[System`List["EdgeDetect", "@", "alpha"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["imgoutline", "=", System`RowBox[System`List["SetAlphaChannel", "[", System`RowBox[System`List["img", ",", "outline"]], "]"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "imgoutline"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["diffuse", "=", System`RowBox[System`List["NearestFilter", "@", "imgoutline"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "diffuse"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List["compute", " ", "normals", " ", "in", " ", "distance", " ", "field", " ", "via", " ", "symmetric", " ", "differences", " ", "in", " ", "x", " ", "and", " ", "y", " ", "direction"]], "*)"]], System`RowBox[System`List[System`RowBox[System`List["{", System`RowBox[System`List["xnor", ",", "ynor"]], "}"]], "=", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["ImageData", "@", System`RowBox[System`List["ImageConvolve", "[", System`RowBox[System`List[System`RowBox[System`List["Image", "@", "distanceField"]], ",", System`RowBox[System`List["#", "@", System`RowBox[System`List["{", System`RowBox[System`List["{", System`RowBox[System`List["1", ",", "0", ",", System`RowBox[System`List["-", "1"]]]], "}"]], "}"]]]]]], "]"]]]], "&"]], "/@", System`RowBox[System`List["{", System`RowBox[System`List["Identity", ",", "Transpose"]], "}"]]]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "[", System`RowBox[System`List["MatrixPlot", "/@", System`RowBox[System`List["{", System`RowBox[System`List["xnor", ",", "ynor"]], "}"]]]], "]"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["normals", "=", System`RowBox[System`List["Map", "[", System`RowBox[System`List["Normalize", ",", System`RowBox[System`List["MatrixInterleave", "@", System`RowBox[System`List["{", System`RowBox[System`List["xnor", ",", "ynor"]], "}"]]]], ",", System`RowBox[System`List["{", "2", "}"]]]], "]"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", System`RowBox[System`List["ListNormalVectorPlot", "@", "normals"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List["compute", " ", "lighting", " ", "model", " ", "response", " ", "using", " ", "normals", " ", "and", " ", "lighting", " ", "model"]], "*)"]], System`RowBox[System`List["(*", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["light", " ", "is", " ", "assumed", " ", "monochrome", " ", "white"]], "-", System`RowBox[System`List["otherwise", " ", "the", " ", "whole", " ", "scene", " ", "is", " ", "just", " ", "tinted"]]]], ",", System`RowBox[System`List["cannot", " ", "differentiate"]]]], "*)"]], System`RowBox[System`List["litImage", "=", System`RowBox[System`List[System`RowBox[System`List["Map", "[", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["lightIntensityParametrized", "[", System`RowBox[System`List["lv", ",", "#"]], "]"]], "&"]], ",", "normals", ",", System`RowBox[System`List["{", "2", "}"]]]], "]"]], "//", "Image"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "litImage"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["litOutline", "=", System`RowBox[System`List["ImageMultiply", "[", System`RowBox[System`List["litImage", ",", "imgoutline"]], "]"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "litOutline"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["litColors", "=", System`RowBox[System`List["NearestFilter", "@", "litOutline"]]]], ";", "\[IndentingNewLine]", System`RowBox[System`List["DPrint", "@", "litColors"]], ";", "\[IndentingNewLine]", System`RowBox[System`List["(*", System`RowBox[System`List["data", " ", "representation", " ", "formatting"]], "*)"]], System`RowBox[System`List["{", System`RowBox[System`List[System`RowBox[System`List["\"colorDim\"", "\[Rule]", "colorDims"]], ",", System`RowBox[System`List["\"l\"", "\[Rule]", "lv"]], ",", System`RowBox[System`List["\"c\"", "\[Rule]", System`RowBox[System`List["ArrayReshape", "[", System`RowBox[System`List[System`RowBox[System`List["ImageData", "@", System`RowBox[System`List["RemoveAlphaChannel", "@", "litColors"]]]], ",", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["(", System`RowBox[System`List["Dimensions", "@", System`RowBox[System`List["ImageData", "@", System`RowBox[System`List["RemoveAlphaChannel", "@", "litColors"]]]]]], ")"]], "[", System`RowBox[System`List["[", System`RowBox[System`List[";;", "2"]], "]"]], "]"]], "~", "Append", "~", "colorDims"]]]], "]"]]]], ",", System`RowBox[System`List["\"normalSharp\"", "\[Rule]", "normals"]], ",", System`RowBox[System`List["\"d\"", "\[Rule]", "measuredDistanceField"]], ",", System`RowBox[System`List["\"doriginal\"", "\[Rule]", "measuredDistanceField"]], ",", System`RowBox[System`List["\"dsharp\"", "\[Rule]", "distanceField"]], ",", System`RowBox[System`List["\"a\"", "\[Rule]", System`RowBox[System`List["ConstantArray", "[", System`RowBox[System`List["1.", ",", System`RowBox[System`List["Dimensions", "@", "distanceField"]]]], "]"]]]], ",", System`RowBox[System`List["\"diffuse\"", "\[Rule]", System`RowBox[System`List["ImageData", "@", System`RowBox[System`List["RemoveAlphaChannel", "@", "diffuse"]]]]]]]], "\[IndentingNewLine]", "}"]]]]]], System`RowBox[System`List["(*", System`RowBox[System`List["return", " ", System`RowBox[System`List["value", "!"]]]], "*)"]], "\[IndentingNewLine]", "]"]]]], "\[IndentingNewLine]", "\[IndentingNewLine]", "]"]]], "Input", System`Rule[System`CellChangeTimes, System`List[System`List[3.6805635175748672`*^9, 3.6805635864137363`*^9], System`List[3.68056362122238`*^9, 3.6805638020075397`*^9], 3.6805646352559967`*^9, 3.6805649539622593`*^9, System`List[3.680651984559949`*^9, 3.6806520597427597`*^9], System`List[3.6808932484013114`*^9, 3.680893256354744`*^9], System`List[3.6808933552963037`*^9, 3.6808933909383802`*^9], System`List[3.6808937840157185`*^9, 3.680893800219486`*^9], System`List[3.6808941068101006`*^9, 3.6808941204825373`*^9], 3.6815657138179398`*^9, System`List[3.6815663943985715`*^9, 3.6815663945467567`*^9], System`List[3.681566438893118`*^9, 3.681566463067297`*^9], System`List[3.6817267112975163`*^9, 3.6817267302860966`*^9], System`List[3.6817322909097157`*^9, 3.6817323094110513`*^9]]], System`Rule[System`CellTags, "depersistedCell4b37c5d4-7d71-4113-865c-d53e74810f68"]]