System`Cell[System`BoxData[System`List[System`RowBox[System`List["Persist", "[", System`RowBox[System`List["CformSymbolic", ",", "\n", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["Unprotect", "@", "Cform"]], ";", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["Cform", "::", "nestedhead"]], " ", "=", " ", "\"Nested heads detected in ``, unsupported in C.\""]], ";", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["Cform", "::", "numerichead"]], " ", "=", " ", "\"Numeric heads detected in ``, unsupported in C.\""]], ";", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["Cform", "::", "unknownSym"]], " ", "=", " ", "\"Symbols unknown to C: `` detected in ``\""]], ";", "\n", System`RowBox[System`List["Protect", "@", "Cform"]], ";", "\n", "  ", "\n", "  ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["TODO", " ", "Simplify", " ", "assuming", " ", "all", " ", "variables", " ", "are", " ", "real", " ", "and", " ", "all", " ", "functions", " ", "are", " ", "real", " ", System`RowBox[System`List["valued", "?", " ", "\n", "  ", "Deal"]], " ", "with", " ", System`RowBox[System`List["If", "[", "]"]], " ", "like", " ", "with", " ", "Piecewise", " ", System`RowBox[System`List["(", System`RowBox[System`List["and", " ", System`RowBox[System`List["Which", "?", " ", "Switch", "?"]]]], ")"]]]], "*)"]], "\n", "\n", "\n", System`RowBox[System`List["RedefinePublicFunction", "[", "\n", System`RowBox[System`List[System`RowBox[System`List["CformSymbolic", "[", System`RowBox[System`List["expr_", ",", " ", System`RowBox[System`List["variableReplacements_List", " ", ":", " ", System`RowBox[System`List["{", "}"]]]], ",", "\n", "  ", System`RowBox[System`List["extraRules_List", " ", ":", " ", System`RowBox[System`List["{", "}"]]]]]], "]"]], "\n", "\n", "  ", ",", "\"C code evaluating this expression, as long as all variables are real valued and functions are simple\"", "\n", "\n", " ", ",", " ", System`RowBox[System`List["Module", "[", System`RowBox[System`List[System`RowBox[System`List["{", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["result", " ", "=", " ", System`RowBox[System`List["expr", " ", "/.", " ", "variableReplacements"]]]], ",", "\n", "  ", System`RowBox[System`List["allRules", " ", "=", " ", System`RowBox[System`List["Join", "[", System`RowBox[System`List["extraRules", ",", " ", System`RowBox[System`List["{", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["Sin", "[", "x_", "]"]], " ", ":>", " ", System`RowBox[System`List["sin", "[", "x", "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Cos", "[", "x_", "]"]], " ", ":>", " ", System`RowBox[System`List["cos", "[", "x", "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Sqrt", "[", System`RowBox[System`List["x_", "?", System`RowBox[System`List["(", System`RowBox[System`List["Not", "@*", "TrueQ", "@*", "Negative"]], ")"]]]], "]"]], " ", ":>", " ", System`RowBox[System`List["sqrt", "[", "x", "]"]]]], ",", " ", System`RowBox[System`List["(*", System`RowBox[System`List[System`RowBox[System`List["don", "'"]], "t", " ", "take", " ", "sqrt", " ", "of", " ", "manifest", " ", "negatives"]], "*)"]], "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Abs", "[", "x_", "]"]], " ", ":>", " ", System`RowBox[System`List["abs", "[", "x", "]"]]]], ",", "\n", "    ", System`RowBox[System`List["(*", " ", System`RowBox[System`List["add", " ", "more", " ", System`RowBox[System`List["math", ".", "h"]], " ", "and", " ", "custom", " ", "functions", " ", "here", " ", System`RowBox[System`List["(", System`RowBox[System`List[System`RowBox[System`List["e", ".", "g", ".", " ", System`RowBox[System`List["Tan", "[", "x_", "]"]]]], " ", ":>", " ", System`RowBox[System`List["tan", "[", "x", "]"]]]], ")"]], " ", "and", " ", "extend", " ", "defines", " ", "accordingly"]], " ", "*)"]], "\n", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Power", "[", System`RowBox[System`List["x_", ",", " ", System`RowBox[System`List[System`RowBox[System`List["-", "1"]], "/", "2"]]]], "]"]], " ", ":>", " ", System`RowBox[System`List["rsqrt", "[", "x", "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Power", "[", System`RowBox[System`List["x_", ",", " ", "2"]], "]"]], " ", ":>", " ", System`RowBox[System`List["sqr", "[", "x", "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Power", "[", System`RowBox[System`List["x_", ",", " ", System`RowBox[System`List["-", "1"]]]], "]"]], " ", ":>", " ", System`RowBox[System`List["inv", "[", "x", "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Power", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["pow", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["Derivative", "[", "1", "]"]], "[", "Abs", "]"]], "[", "x_", "]"]], " ", ":>", " ", System`RowBox[System`List["ifthenelse", "[", System`RowBox[System`List[System`RowBox[System`List["x", " ", "<", " ", "0"]], ",", " ", System`RowBox[System`List["-", "1"]], ",", " ", "1"]], "]"]]]], ",", " ", System`RowBox[System`List["(*", System`RowBox[System`List["good", " ", "enough"]], "*)"]], "\n", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Equal", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", "\[RuleDelayed]", " ", System`RowBox[System`List["equal", "[", System`RowBox[System`List["x", ",", "y"]], "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Greater", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["greater", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Less", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["less", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["GreaterEqual", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["greaterEqual", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["LessEqual", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["lessEqual", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "\n", "\t", System`RowBox[System`List["And", "\[RuleDelayed]", "and"]], ",", "\n", "\t", System`RowBox[System`List[System`RowBox[System`List["and", "[", System`RowBox[System`List["x_", ",", "y_", ",", "rest__"]], "]"]], " ", "\[RuleDelayed]", " ", System`RowBox[System`List["and", "[", System`RowBox[System`List[System`RowBox[System`List["and", "[", System`RowBox[System`List["x", ",", "y"]], "]"]], ",", "rest"]], "]"]]]], ",", System`RowBox[System`List["(*", System`RowBox[System`List[System`RowBox[System`List["and", " ", "must", " ", "associate", " ", "to", " ", "the", " ", "left", " ", "to", " ", "preserve", " ", "short"]], "-", "circuiting"]], "*)"]], "\n", "\t", "\n", "\t", System`RowBox[System`List["Or", "\[RuleDelayed]", "or"]], ",", "\n", "\t", System`RowBox[System`List[System`RowBox[System`List["or", "[", System`RowBox[System`List["x_", ",", "y_", ",", "rest__"]], "]"]], " ", "\[RuleDelayed]", " ", System`RowBox[System`List["or", "[", System`RowBox[System`List[System`RowBox[System`List["or", "[", System`RowBox[System`List["x", ",", "y"]], "]"]], ",", "rest"]], "]"]]]], ",", System`RowBox[System`List["(*", System`RowBox[System`List[System`RowBox[System`List["or", " ", "must", " ", "associate", " ", "to", " ", "the", " ", "left", " ", "to", " ", "preserve", " ", "short"]], "-", "circuiting"]], "*)"]], "\n", "\t", "\n", "\t", "\n", "    ", System`RowBox[System`List["Piecewise", " ", ":>", " ", "piecewise"]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["piecewise", "[", System`RowBox[System`List[System`RowBox[System`List["{", "}"]], ",", " ", "finally_"]], "]"]], " ", ":>", " ", "finally"]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["piecewise", "[", System`RowBox[System`List[System`RowBox[System`List["{", System`RowBox[System`List[System`RowBox[System`List["{", System`RowBox[System`List["e_", ",", " ", "cond_"]], "}"]], ",", " ", "rest___"]], "}"]], ",", " ", "finally_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["ifthenelse", "[", "\n", "      ", System`RowBox[System`List["cond", ",", " ", "e", ",", " ", System`RowBox[System`List["piecewise", "[", System`RowBox[System`List[System`RowBox[System`List["{", "rest", "}"]], ",", " ", "finally"]], "]"]]]], "\n", "    ", "]"]]]], ",", "\n", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Times", "[", System`RowBox[System`List[System`RowBox[System`List["-", "1"]], ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["neg", "[", "y", "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Times", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["times", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Plus", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["plus", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Max", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["max", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["Min", "[", System`RowBox[System`List["x_", ",", " ", "y_"]], "]"]], " ", ":>", " ", System`RowBox[System`List["min", "[", System`RowBox[System`List["x", ",", " ", "y"]], "]"]]]], ",", "\n", "    ", System`RowBox[System`List["x_Integer", " ", ":>", " ", "x"]], ",", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["x_", "?", "NumericQ"]], " ", ":>", " ", System`RowBox[System`List["N", "[", "x", "]"]]]]]], "\n", "  ", "}"]]]], "]"]]]]]], "\n", "}"]], ",", " ", System`RowBox[System`List["Module", "[", System`RowBox[System`List[System`RowBox[System`List["{", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List["knownSymbols", " ", "=", " ", System`RowBox[System`List["DeleteDuplicates", "[", "\n", "    ", System`RowBox[System`List["SymbolicHead", " ", "/@", "\n", "        ", System`RowBox[System`List["Join", "[", System`RowBox[System`List[System`RowBox[System`List["Values", "@", "variableReplacements"]], ",", "\n", "          ", System`RowBox[System`List["Values", "@", "allRules"]], ",", " ", System`RowBox[System`List["{", System`RowBox[System`List["Real", ",", " ", "Integer"]], "}"]]]], "]"]]]], "\n", "  ", "]"]]]], ",", "\n", "  ", System`RowBox[System`List["hasNested", " ", "=", " ", "False"]], ",", " ", "symbols", ",", " ", System`RowBox[System`List["hasNumeric", " ", "=", " ", "False"]], ",", " ", "Trace"]], "\n", "}"]], ",", "\n", "  ", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["Trace", "[", "x___", "]"]], " ", ":=", " ", System`RowBox[System`List["Message", "[", System`RowBox[System`List[System`RowBox[System`List["CformSymbolic", "::", "trace"]], ",", " ", "x", ",", "Null", ",", "Null"]], "]"]]]], ";", "\n", "  ", System`RowBox[System`List["Trace", "[", System`RowBox[System`List["\"expr: \"", ",", " ", "expr"]], "]"]], ";", "\n", "  ", System`RowBox[System`List["Trace", "[", System`RowBox[System`List["\"variableReplacements: \"", ",", "variableReplacements"]], "]"]], ";", "\n", "  ", System`RowBox[System`List["Trace", "[", System`RowBox[System`List["\"extraRules: \"", ",", " ", "extraRules"]], "]"]], ";", "\n", "  ", System`RowBox[System`List["Trace", "@", "allRules"]], "\n", "  ", ";", System`RowBox[System`List["Trace", "[", System`RowBox[System`List["\"knownSymbols \"", ",", " ", "knownSymbols"]], "]"]], "\n", "\n", "  ", ";", System`RowBox[System`List["Trace", "@", "result"]], "\n", "  ", ";", System`RowBox[System`List["result", " ", "=", " ", System`RowBox[System`List["result", " ", "//.", " ", "allRules"]]]], "\n", "  ", ";", System`RowBox[System`List["Trace", "@", "result"]], "\n", "\n", "  ", ";", System`RowBox[System`List["symbols", " ", "=", " ", System`RowBox[System`List["(", System`RowBox[System`List["SymbolicHead", " ", "/@", " ", System`RowBox[System`List["Level", "[", System`RowBox[System`List["result", ",", " ", System`RowBox[System`List["{", System`RowBox[System`List["-", "1"]], "}"]], ",", " ", System`RowBox[System`List["Heads", " ", "->", " ", "True"]]]], "]"]]]], ")"]]]], "\n", "  ", ";", System`RowBox[System`List["Trace", "[", System`RowBox[System`List["\"ksm \"", ",", " ", "symbols", ",", " ", System`RowBox[System`List["knownSymbols", "~", "ContainsAll", "~", "symbols"]]]], "]"]], "\n", "  ", ";", System`RowBox[System`List["If", "[", "\n", "    ", System`RowBox[System`List[System`RowBox[System`List[System`RowBox[System`List["knownSymbols", "~", "ContainsAll", "~", "\n", "        ", "symbols"]], " ", "&&", " ", System`RowBox[System`List["!", " ", System`RowBox[System`List["(", System`RowBox[System`List["hasNested", " ", "=", " ", System`RowBox[System`List["NestedHeadsQ", "@", "result"]]]], ")"]]]], " ", "&&", " ", System`RowBox[System`List["!", " ", System`RowBox[System`List["(", System`RowBox[System`List["hasNumeric", " ", "=", " ", System`RowBox[System`List["NumericHeadsQ", "@", "result"]]]], ")"]]]]]], "\n", "\n", "\n", "    ", ",", " ", System`RowBox[System`List["(*", System`RowBox[System`List[System`RowBox[System`List["--", " ", "make"]], " ", "CForm", " ", "without", " ", "any", " ", System`RowBox[System`List["contexts_", " ", "--"]]]], " ", "*)"]], "\n", "    ", System`RowBox[System`List[System`RowBox[System`List["result", " ", "//", " ", "Evaluate"]], " ", "//", " ", "SymbolicCForm"]], "\n", "\n", "    ", ",", " ", System`RowBox[System`List["(*", " ", System`RowBox[System`List[System`RowBox[System`List["--", "else"]], " ", "there", " ", "is", " ", "SOMETHING", " ", System`RowBox[System`List["wrong", " ", "--"]], " ", "determine", " ", "what"]], " ", "*)"]], " ", System`RowBox[System`List[System`RowBox[System`List["Which", "[", "\n", "\n", "      ", System`RowBox[System`List["hasNested", "\n", "      ", ",", " ", System`RowBox[System`List["Message", "[", System`RowBox[System`List[System`RowBox[System`List["Cform", "::", "nestedhead"]], ",", " ", "result"]], "]"]], "\n", "\n", "      ", ",", " ", "hasNumeric", "\n", "      ", ",", " ", System`RowBox[System`List["Message", "[", System`RowBox[System`List[System`RowBox[System`List["Cform", "::", "numerichead"]], ",", " ", "result"]], "]"]], "\n", "\n", "      ", ",", " ", "True", "\n", "      ", ",", " ", System`RowBox[System`List["Message", "[", System`RowBox[System`List[System`RowBox[System`List["Cform", "::", "unknownSym"]], ",", " ", System`RowBox[System`List["FullSymbolName", " ", "/@", " ", System`RowBox[System`List["Complement", "[", System`RowBox[System`List["symbols", ",", " ", "knownSymbols"]], "]"]]]], ",", " ", "result"]], "]"]]]], "\n", "    ", "]"]], ";", " ", "$Failed"]]]], "\n", "  ", "]"]]]]]], "\n", "]"]]]], "]"]]]], "\n", "\n", "]"]], ";", "\n", "\n", System`RowBox[System`List["Off", "[", System`RowBox[System`List["CformSymbolic", "::", "trace"]], "]"]], ";"]]]], "\n", "]"]], "\n"]], "Code", System`Rule[System`CellChangeTimes, System`List[System`List[3.6816791035060425`*^9, 3.6816791035060425`*^9], 3.681679335515255`*^9, System`List[3.68167938348979`*^9, 3.681679418579034`*^9], System`List[3.681679495947085`*^9, 3.6816796296847115`*^9], 3.6854298906252165`*^9, System`List[3.685429949674569`*^9, 3.685429960972387`*^9], System`List[3.6854300691364083`*^9, 3.6854301318811064`*^9], System`List[3.6854314071134696`*^9, 3.6854314173638983`*^9], System`List[3.6854364994296627`*^9, 3.6854365564945507`*^9], System`List[3.6854366008557796`*^9, 3.6854366854499283`*^9]]], System`Rule[System`CellTags, "depersistedCell690248cc-81f7-4f39-87fb-a912a9e169be"]]